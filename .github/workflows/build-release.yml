name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_VERSION: '1.0.1'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
      
    - name: Test (if tests exist)
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true
      
    - name: Create portable packages
      run: |
        Write-Host "Creating portable packages..." -ForegroundColor Cyan
        
        # Framework-dependent portable
        Write-Host "Building framework-dependent version..." -ForegroundColor Yellow
        New-Item -ItemType Directory -Path "./publish/framework/ui" -Force | Out-Null
        dotnet publish src/CursorCloak.UI/CursorCloak.UI.csproj --configuration Release --runtime win-x64 --self-contained false --output ./publish/framework/ui/
        
        # Self-contained portable  
        Write-Host "Building self-contained version..." -ForegroundColor Yellow
        New-Item -ItemType Directory -Path "./publish/self-contained/ui" -Force | Out-Null
        dotnet publish src/CursorCloak.UI/CursorCloak.UI.csproj --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true --output ./publish/self-contained/ui/
        
        # Create ZIP packages
        Write-Host "Creating ZIP packages..." -ForegroundColor Yellow
        Compress-Archive -Path "./publish/framework/ui/*" -DestinationPath "./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64.zip" -Force
        Compress-Archive -Path "./publish/self-contained/ui/*" -DestinationPath "./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64-selfcontained.zip" -Force
        
        # Display package sizes
        $frameworkSize = [math]::Round((Get-Item "./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64.zip").Length / 1MB, 1)
        $selfContainedSize = [math]::Round((Get-Item "./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64-selfcontained.zip").Length / 1MB, 1)
        Write-Host "Framework ZIP: $frameworkSize MB" -ForegroundColor Green
        Write-Host "Self-contained ZIP: $selfContainedSize MB" -ForegroundColor Green
      shell: powershell
      
    - name: Setup InnoSetup
      run: |
        Write-Host "Setting up InnoSetup..." -ForegroundColor Cyan
        
        # Download and install Inno Setup 6.2.2 (latest stable)
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "innosetup-installer.exe"
        
        Write-Host "Downloading InnoSetup from $url..." -ForegroundColor Yellow
        Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
        
        Write-Host "Installing InnoSetup..." -ForegroundColor Yellow
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
        
        # Verify installation
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "InnoSetup installed successfully at: $isccPath" -ForegroundColor Green
          & $isccPath
        } else {
          Write-Host "InnoSetup installation verification failed" -ForegroundColor Red
          Write-Host "Searching for InnoSetup installation..." -ForegroundColor Yellow
          Get-ChildItem "C:\Program Files (x86)\" -Name "*nno*" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $_" }
          Get-ChildItem "C:\Program Files\" -Name "*nno*" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $_" }
        }
      shell: powershell
      
    - name: Build installers with InnoSetup
      run: |
        Write-Host "Building installers..." -ForegroundColor Cyan
        
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (-not (Test-Path $isccPath)) {
          Write-Warning "InnoSetup not found. Checking alternative locations..."
          
          # Check common alternative paths
          $alternativePaths = @(
            "C:\Program Files\Inno Setup 6\ISCC.exe",
            "C:\tools\InnoSetup\ISCC.exe"
          )
          
          foreach ($path in $alternativePaths) {
            if (Test-Path $path) {
              $isccPath = $path
              Write-Host "Found InnoSetup at: $isccPath" -ForegroundColor Green
              break
            }
          }
          
          if (-not (Test-Path $isccPath)) {
            Write-Error "InnoSetup not found in any expected location. Skipping installer creation."
            exit 1
          }
        }
        
        # Ensure output directory exists
        New-Item -ItemType Directory -Path "./releases" -Force | Out-Null
        
        try {
          # Build framework-dependent installer
          Write-Host "Building framework-dependent installer..." -ForegroundColor Yellow
          & $isccPath "scripts\setup.iss"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Framework installer built successfully" -ForegroundColor Green
          } else {
            Write-Error "Framework installer build failed with exit code $LASTEXITCODE"
          }
          
          # Build self-contained installer
          Write-Host "Building self-contained installer..." -ForegroundColor Yellow
          & $isccPath "scripts\setup-selfcontained.iss"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Self-contained installer built successfully" -ForegroundColor Green
          } else {
            Write-Error "Self-contained installer build failed with exit code $LASTEXITCODE"
          }
        } catch {
          Write-Error "Installer build failed: $($_.Exception.Message)"
          throw
        }
        
        # List created files
        Write-Host "Created installers:" -ForegroundColor Cyan
        Get-ChildItem "./releases/*.exe" | ForEach-Object {
          $size = [math]::Round($_.Length / 1MB, 1)
          Write-Host "  $($_.Name) ($size MB)" -ForegroundColor White
        }
      shell: powershell
      continue-on-error: false
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CursorCloak-v${{ env.PROJECT_VERSION }}-Build
        path: |
          ./publish/
          ./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64.zip
          ./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64-selfcontained.zip
          ./releases/CursorCloak_Setup_v${{ env.PROJECT_VERSION }}.exe
          ./releases/CursorCloak_Setup_v${{ env.PROJECT_VERSION }}_SelfContained.exe
        retention-days: 30
          
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: CursorCloak-v${{ env.PROJECT_VERSION }}-Build
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64.zip
          ./CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64-selfcontained.zip
          ./releases/CursorCloak_Setup_v${{ env.PROJECT_VERSION }}.exe
          ./releases/CursorCloak_Setup_v${{ env.PROJECT_VERSION }}_SelfContained.exe
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## üéØ CursorCloak v${{ env.PROJECT_VERSION }} - Enhanced Patch Release

          ### ‚ú® What's New:
          - **üîß Fixed 'Start with Windows' functionality** - Now properly saves and applies settings when toggled
          - **üóëÔ∏è Professional Uninstaller** - Complete cleanup including registry entries and user data  
          - **‚úÖ Enhanced Registry Management** - Improved startup entry handling with validation
          - **üõ°Ô∏è Better Error Handling** - More robust registry access and file operations
          - **üìã Comprehensive Cleanup** - Uninstaller removes all traces of the application

          ### üì¶ Download Options:
          - **CursorCloak_Setup_v${{ env.PROJECT_VERSION }}.exe** - Framework-dependent installer (requires .NET 9.0) - ~2MB
          - **CursorCloak_Setup_v${{ env.PROJECT_VERSION }}_SelfContained.exe** - Self-contained installer (no .NET required) - ~66MB
          - **CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64.zip** - Framework-dependent portable (requires .NET 9.0) - ~0.3MB
          - **CursorCloak-v${{ env.PROJECT_VERSION }}-win-x64-selfcontained.zip** - Self-contained portable (no .NET required) - ~66MB

          ### üîß Requirements:
          - Windows 10/11 (x64)
          - Administrator privileges
          - .NET 9.0 Runtime (for framework-dependent versions only)

          ### üöÄ Usage:
          - **Alt + H**: Hide cursor anywhere in Windows
          - **Alt + S**: Show cursor again
          - Close window to run in background mode

          **üõ°Ô∏è SmartScreen Notice:** Windows may show a security warning. Click "More info" ‚Üí "Run anyway". This is normal for unsigned applications.

          Always run as administrator for proper functionality.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
