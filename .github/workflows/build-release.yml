name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
      
    - name: Test (if tests exist)
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true
      
    - name: Create portable packages
      run: |
        # Framework-dependent portable
        New-Item -ItemType Directory -Path "./publish/framework/ui" -Force
        dotnet publish CursorCloak.UI/CursorCloak.UI.csproj --configuration Release --runtime win-x64 --self-contained false --output ./publish/framework/ui/
        
        # Self-contained portable  
        New-Item -ItemType Directory -Path "./publish/self-contained/ui" -Force
        dotnet publish CursorCloak.UI/CursorCloak.UI.csproj --configuration Release --runtime win-x64 --self-contained true --output ./publish/self-contained/ui/
        
        # Create ZIP packages
        Compress-Archive -Path "./publish/framework/ui/*" -DestinationPath "./CursorCloak-v1.0.1-win-x64.zip" -Force
        Compress-Archive -Path "./publish/self-contained/ui/*" -DestinationPath "./CursorCloak-v1.0.1-win-x64-selfcontained.zip" -Force
      shell: powershell
      
    - name: Setup InnoSetup
      run: |
        # Download and install Inno Setup
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "innosetup-installer.exe"
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
        Write-Host "Inno Setup installation completed"
      shell: powershell
      
    - name: Build installer
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "Building installers with Inno Setup..."
          
          # Build framework-dependent installer
          & $isccPath "setup.iss"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Framework installer built successfully"
          } else {
            Write-Error "Framework installer build failed with exit code $LASTEXITCODE"
          }
          
          # Build self-contained installer
          & $isccPath "setup-selfcontained.iss"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Self-contained installer built successfully"
          } else {
            Write-Error "Self-contained installer build failed with exit code $LASTEXITCODE"
          }
        } else {
          Write-Warning "Inno Setup not found at expected location: $isccPath"
          Get-ChildItem "C:\Program Files (x86)\" -Name "*nno*" -Recurse -ErrorAction SilentlyContinue
        }
      shell: powershell
      continue-on-error: true
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CursorCloak-Build
        path: |
          ./publish/
          ./CursorCloak-v1.0.1-win-x64.zip
          ./CursorCloak-v1.0.1-win-x64-selfcontained.zip
          ./Installer/CursorCloak_Setup_v1.0.1.exe
          ./Installer/CursorCloak_Setup_v1.0.1_SelfContained.exe
          
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: CursorCloak-Build
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./CursorCloak-v1.0.1-win-x64.zip
          ./CursorCloak-v1.0.1-win-x64-selfcontained.zip
          ./Installer/CursorCloak_Setup_v1.0.1.exe
          ./Installer/CursorCloak_Setup_v1.0.1_SelfContained.exe
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## üéØ CursorCloak v1.0.1 - Enhanced Patch Release

          ### ‚ú® What's New:
          - **üîß Fixed 'Start with Windows' functionality** - Now properly saves and applies settings when toggled
          - **üóëÔ∏è Professional Uninstaller** - Complete cleanup including registry entries and user data  
          - **‚úÖ Enhanced Registry Management** - Improved startup entry handling with validation
          - **üõ°Ô∏è Better Error Handling** - More robust registry access and file operations
          - **üìã Comprehensive Cleanup** - Uninstaller removes all traces of the application

          ### üì¶ Download Options:
          - **CursorCloak_Setup_v1.0.1.exe** - Framework-dependent installer (requires .NET 9.0) - ~2MB
          - **CursorCloak_Setup_v1.0.1_SelfContained.exe** - Self-contained installer (no .NET required) - ~66MB
          - **CursorCloak-v1.0.1-win-x64.zip** - Framework-dependent portable (requires .NET 9.0) - ~0.3MB
          - **CursorCloak-v1.0.1-win-x64-selfcontained.zip** - Self-contained portable (no .NET required) - ~66MB

          ### üîß Requirements:
          - Windows 10/11 (x64)
          - Administrator privileges
          - .NET 9.0 Runtime (for framework-dependent versions only)

          ### üöÄ Usage:
          - **Alt + H**: Hide cursor anywhere in Windows
          - **Alt + S**: Show cursor again
          - Close window to run in background mode

          **üõ°Ô∏è SmartScreen Notice:** Windows may show a security warning. Click "More info" ‚Üí "Run anyway". This is normal for unsigned applications.

          Always run as administrator for proper functionality.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
