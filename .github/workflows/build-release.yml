name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
      
    - name: Test (if tests exist)
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true
      
    - name: Publish UI application (Self-Contained)
      run: dotnet publish CursorCloak.UI/CursorCloak.UI.csproj --configuration Release --runtime win-x64 --self-contained true --output ./publish/ui/
      
    - name: Publish Engine application  
      run: dotnet publish CursorCloak.Engine/CursorCloak.Engine.csproj --configuration Release --runtime win-x64 --self-contained true --output ./publish/engine/
      
    - name: Create portable packages
      run: |
        # Self-contained portable
        New-Item -ItemType Directory -Path "./portable" -Force
        Copy-Item -Path "./publish/ui/*" -Destination "./portable/" -Recurse
        Compress-Archive -Path "./portable/*" -DestinationPath "./CursorCloak-v1.2.0-win-x64.zip" -Force
      shell: powershell
      
    - name: Setup InnoSetup
      run: |
        # Download and install Inno Setup
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "innosetup-installer.exe"
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
        Write-Host "Inno Setup installation completed"
      shell: powershell
      
    - name: Build installer
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "Building installer with Inno Setup..."
          & $isccPath "setup.iss"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Installer built successfully"
          } else {
            Write-Error "Installer build failed with exit code $LASTEXITCODE"
          }
        } else {
          Write-Warning "Inno Setup not found at expected location: $isccPath"
          Get-ChildItem "C:\Program Files (x86)\" -Name "*nno*" -Recurse -ErrorAction SilentlyContinue
        }
      shell: powershell
      continue-on-error: true
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CursorCloak-Build
        path: |
          ./publish/
          ./portable/
          ./CursorCloak-v1.2.0-win-x64.zip
          ./Installer/CursorCloak_Setup.exe
          
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: CursorCloak-Build
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./CursorCloak-v1.2.0-win-x64.zip
          ./Installer/CursorCloak_Setup.exe
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## CursorCloak Release
          
          ### Download Options:
          - **Installer (Recommended)**: `CursorCloak_Setup.exe` - Full installer with shortcuts and uninstaller
          - **Portable (Self-Contained)**: `CursorCloak-v1.2.0-win-x64.zip` - Includes .NET runtime (~60MB)
          
          ### Requirements:
          - Windows 10/11
          - Administrator privileges
          
          ### Usage:
          - **Alt + H**: Hide cursor
          - **Alt + S**: Show cursor
          
          Run as administrator for proper functionality.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
